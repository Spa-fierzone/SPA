<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - SpaZone'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .my-schedule-card {
            border-left: 4px solid #17a2b8;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .my-schedule-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .schedule-time {
            font-size: 1.2rem;
            font-weight: 600;
            color: #17a2b8;
        }
        .schedule-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .day-header {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .view-selector {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .my-stats {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .upcoming-schedule {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .no-schedule {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-user-clock me-2"></i>
                            <span th:text="${pageTitle}"></span>
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-calendar-alt"></i> Xem theo
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="changeView('day')">Ngày</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeView('week')">Tuần</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeView('month')">Tháng</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Personal Stats -->
                        <div class="my-stats">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${schedules.size()}">0</div>
                                        <div class="small">Tổng ca làm</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${completedSchedulesCount}">0</div>
                                        <div class="small">Đã hoàn thành</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${upcomingSchedulesCount}">0</div>
                                        <div class="small">Sắp tới</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${totalWorkingHours}">0</div>
                                        <div class="small">Tổng giờ làm</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${distinctBranchesCount}">0</div>
                                        <div class="small">Chi nhánh</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Schedule Alert -->
                        <div th:if="${hasTodaySchedules}"
                             class="upcoming-schedule">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock fa-2x me-3 text-warning"></i>
                                <div>
                                    <h6 class="mb-0">Lịch làm việc hôm nay</h6>
                                    <p class="mb-0 text-muted">
                                        Bạn có <span th:text="${todaySchedulesCount}"></span>
                                        ca làm việc hôm nay. Hãy chuẩn bị sẵn sàng!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Navigation -->
                        <div class="calendar-nav">
                            <button class="btn btn-outline-info" onclick="previousPeriod()">
                                <i class="fas fa-chevron-left"></i>
                                <span th:text="${viewType == 'day' ? 'Ngày trước' : (viewType == 'month' ? 'Tháng trước' : 'Tuần trước')}"></span>
                            </button>

                            <div class="text-center">
                                <h6 class="mb-0">
                                    <span th:if="${viewType == 'day'}" th:text="'Ngày ' + ${#temporals.format(viewDate, 'dd/MM/yyyy')}"></span>
                                    <span th:if="${viewType == 'week'}" th:text="'Tuần ' + ${#temporals.format(viewDate, 'w/yyyy')}"></span>
                                    <span th:if="${viewType == 'month'}" th:text="'Tháng ' + ${#temporals.format(viewDate, 'MM/yyyy')}"></span>
                                </h6>
                            </div>

                            <button class="btn btn-outline-info" onclick="nextPeriod()">
                                <span th:text="${viewType == 'day' ? 'Ngày sau' : (viewType == 'month' ? 'Tháng sau' : 'Tuần sau')}"></span>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <!-- Schedule List -->
                        <div class="row">
                            <div class="col-md-12">
                                <div th:if="${schedules.isEmpty()}" class="no-schedule">
                                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                                    <h5>Không có lịch làm việc</h5>
                                    <p class="text-muted">Bạn không có lịch làm việc nào trong thời gian này.</p>
                                </div>

                                <div th:unless="${schedules.isEmpty()}">
                                    <!-- Group schedules by date -->
                                    <div th:each="date : ${sortedDates}">
                                        <div class="day-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-calendar-day me-2"></i>
                                                    <span th:text="${#temporals.format(date, 'EEEE, dd/MM/yyyy', new java.util.Locale('vi'))}"></span>
                                                </h6>
                                                <div>
                                                    <span th:if="${date.equals(T(java.time.LocalDate).now())}" class="badge bg-warning text-dark">Hôm nay</span>
                                                    <span th:if="${date.equals(T(java.time.LocalDate).now().plusDays(1))}" class="badge bg-info">Ngày mai</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div th:each="schedule : ${schedulesByDate[date]}"
                                                 class="col-md-6 col-lg-4">
                                                <div class="card my-schedule-card">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="schedule-time" th:text="${schedule.startTime} + ' - ' + ${schedule.endTime}"></div>
                                                            <span th:class="'badge bg-' + ${schedule.status == T(com.spazone.enums.ScheduleStatus).SCHEDULED ? 'info' :
                                                                                             (schedule.status == T(com.spazone.enums.ScheduleStatus).COMPLETED ? 'success' :
                                                                                              (schedule.status == T(com.spazone.enums.ScheduleStatus).CANCELLED ? 'danger' : 'secondary'))}"
                                                                  th:text="${schedule.statusDisplayName}"></span>
                                                        </div>

                                                        <div class="schedule-info mb-2">
                                                            <div><strong>Ca làm:</strong> <span th:text="${schedule.shiftTypeDisplayName}"></span></div>
                                                            <div><strong>Chi nhánh:</strong> <span th:text="${schedule.branchName}"></span></div>
                                                            <div><strong>Thời gian:</strong> <span th:text="${schedule.scheduledHours} + ' giờ'"></span></div>
                                                        </div>

                                                        <div th:if="${schedule.breakStart != null}" class="schedule-info mb-2">
                                                            <div><strong>Giờ nghỉ:</strong> <span th:text="${schedule.breakStart} + ' - ' + ${schedule.breakEnd}"></span></div>
                                                        </div>

                                                        <div th:if="${schedule.notes != null && !schedule.notes.isEmpty()}" class="schedule-info mb-2">
                                                            <div><strong>Ghi chú:</strong> <span th:text="${schedule.notes}"></span></div>
                                                        </div>

                                                        <!-- Action buttons for today's schedule -->
                                                        <div th:if="${schedule.workDate.equals(T(java.time.LocalDate).now()) && schedule.status == T(com.spazone.enums.ScheduleStatus).SCHEDULED}"
                                                             class="mt-3 pt-2 border-top">
                                                            <button class="btn btn-sm btn-outline-success" onclick="checkIn()">
                                                                <i class="fas fa-sign-in-alt"></i> Check-in
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-warning" onclick="checkOut()">
                                                                <i class="fas fa-sign-out-alt"></i> Check-out
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const currentViewType = /*[[${viewType}]]*/ 'week';
        const currentViewDate = new Date(/*[[${viewDate}]]*/ new Date());

        function changeView(viewType) {
            const url = new URL(window.location);
            url.searchParams.set('view', viewType);
            window.location.href = url.toString();
        }

        function previousPeriod() {
            const newDate = new Date(currentViewDate);

            switch(currentViewType) {
                case 'day':
                    newDate.setDate(newDate.getDate() - 1);
                    break;
                case 'week':
                    newDate.setDate(newDate.getDate() - 7);
                    break;
                case 'month':
                    newDate.setMonth(newDate.getMonth() - 1);
                    break;
            }

            updateView(newDate);
        }

        function nextPeriod() {
            const newDate = new Date(currentViewDate);

            switch(currentViewType) {
                case 'day':
                    newDate.setDate(newDate.getDate() + 1);
                    break;
                case 'week':
                    newDate.setDate(newDate.getDate() + 7);
                    break;
                case 'month':
                    newDate.setMonth(newDate.getMonth() + 1);
                    break;
            }

            updateView(newDate);
        }

        function updateView(date) {
            const url = new URL(window.location);
            url.searchParams.set('date', date.toISOString().split('T')[0]);
            window.location.href = url.toString();
        }

        function checkIn() {
            // Implement check-in functionality
            alert('Check-in functionality - to be implemented');
        }

        function checkOut() {
            // Implement check-out functionality
            alert('Check-out functionality - to be implemented');
        }
    </script>
</body>
</html>
