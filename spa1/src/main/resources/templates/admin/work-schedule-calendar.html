<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch làm việc - SpaZone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
        }
        .fc-event.technician { background-color: #007bff; }
        .fc-event.receptionist { background-color: #28a745; }
        .fc-event.manager { background-color: #ffc107; color: #000; }
        .schedule-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Lịch làm việc
                        </h5>
                        <div class="d-flex gap-2">
                             <select class="form-select form-select-sm" id="branchFilter" style="width: 200px;">
                                <option value="">Tất cả chi nhánh</option>
                                <option th:each="branch : ${branches}"
                                        th:value="${branch.branchId}"
                                        th:text="${branch.name}"
                                        th:selected="${branch.branchId == selectedBranchId}">
                                </option>
                            </select>
                            <a href="/schedules/create" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Thêm lịch
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #007bff;"></div>
                                <span>Kỹ thuật viên</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #28a745;"></div>
                                <span>Lễ tân</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffc107;"></div>
                                <span>Quản lý</span>
                            </div>
                        </div>

                        <!-- Calendar -->
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Detail Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết lịch làm việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="scheduleDetails">
                        <!-- Schedule details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="editScheduleBtn">Chỉnh sửa</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const schedules = /*[[${schedules}]]*/ [];

            // Convert schedules to FullCalendar events
            const events = schedules.map(schedule => ({
                id: schedule.scheduleId,
                title: `${schedule.userFullName} (${schedule.shiftTypeDisplayName})`,
                start: `${schedule.workDate}T${schedule.startTime}`,
                end: `${schedule.workDate}T${schedule.endTime}`,
                className: schedule.userRole.toLowerCase(),
                extendedProps: {
                    schedule: schedule
                }
            }));

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                eventClick: function(info) {
                    showScheduleDetails(info.event.extendedProps.schedule);
                },
                height: 'auto',
                locale: 'vi',
                buttonText: {
                    today: 'Hôm nay',
                    month: 'Tháng',
                    week: 'Tuần',
                    day: 'Ngày'
                }
            });

            calendar.render();

            // Branch filter
            document.getElementById('branchFilter').addEventListener('change', function() {
                const branchId = this.value;
                const url = new URL(window.location);
                if (branchId) {
                    url.searchParams.set('branchId', branchId);
                } else {
                    url.searchParams.delete('branchId');
                }
                window.location.href = url.toString();
            });

            // Show schedule details
            function showScheduleDetails(schedule) {
                const detailsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Thông tin nhân viên</h6>
                            <p><strong>Tên:</strong> ${schedule.userFullName}</p>
                            <p><strong>Vai trò:</strong> ${schedule.userRole}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Chi nhánh</h6>
                            <p><strong>Tên chi nhánh:</strong> ${schedule.branchName}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Thời gian</h6>
                            <p><strong>Ngày:</strong> ${schedule.workDate}</p>
                            <p><strong>Ca làm:</strong> ${schedule.shiftTypeDisplayName}</p>
                            <p><strong>Giờ bắt đầu:</strong> ${schedule.startTime}</p>
                            <p><strong>Giờ kết thúc:</strong> ${schedule.endTime}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Trạng thái</h6>
                            <p><strong>Trạng thái:</strong>
                                <span class="badge bg-${getStatusClass(schedule.status)}">${schedule.statusDisplayName}</span>
                            </p>
                            ${schedule.breakStart ? `<p><strong>Giờ nghỉ:</strong> ${schedule.breakStart} - ${schedule.breakEnd}</p>` : ''}
                        </div>
                    </div>
                    ${schedule.notes ? `<div class="row"><div class="col-12"><h6>Ghi chú</h6><p>${schedule.notes}</p></div></div>` : ''}
                `;

                document.getElementById('scheduleDetails').innerHTML = detailsHtml;
                document.getElementById('editScheduleBtn').onclick = function() {
                    window.location.href = `/schedules/edit/${schedule.scheduleId}`;
                };

                new bootstrap.Modal(document.getElementById('scheduleModal')).show();
            }

            function getStatusClass(status) {
                switch(status) {
                    case 'SCHEDULED': return 'primary';
                    case 'COMPLETED': return 'success';
                    case 'CANCELLED': return 'danger';
                    case 'RESCHEDULED': return 'warning';
                    case 'NO_SHOW': return 'secondary';
                    default: return 'secondary';
                }
            }
        });
    </script>
</body>
</html>

