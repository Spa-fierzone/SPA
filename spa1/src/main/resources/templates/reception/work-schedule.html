<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - SpaZone'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .schedule-card {
            border-left: 4px solid #28a745;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .schedule-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .schedule-time {
            font-size: 1.1rem;
            font-weight: 600;
            color: #28a745;
        }
        .schedule-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .day-header {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .no-schedule {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .filter-bar {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .reception-stats {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-desktop me-2"></i>
                            <span th:text="${pageTitle}"></span>
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="previousWeek()">
                                <i class="fas fa-chevron-left"></i> Tuần trước
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="thisWeek()">
                                Tuần này
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="nextWeek()">
                                Tuần sau <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Reception Stats -->
                        <div class="reception-stats">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${schedules.size()}">0</div>
                                        <div class="small">Tổng ca làm</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${schedules.stream().filter(s -> s.status == T(com.spazone.enums.ScheduleStatus).COMPLETED).count()}">0</div>
                                        <div class="small">Đã hoàn thành</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${schedules.stream().filter(s -> s.shiftType == T(com.spazone.enums.ShiftType).MORNING).count()}">0</div>
                                        <div class="small">Ca sáng</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold" th:text="${schedules.stream().filter(s -> s.shiftType == T(com.spazone.enums.ShiftType).AFTERNOON).count()}">0</div>
                                        <div class="small">Ca chiều</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Bar -->
                        <div class="filter-bar">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-2">Thời gian xem:</h6>
                                    <div class="d-flex gap-2">
                                        <input type="date" class="form-control" id="startDate"
                                               th:value="${startDate}">
                                        <span class="align-self-center">đến</span>
                                        <input type="date" class="form-control" id="endDate"
                                               th:value="${endDate}">
                                        <button class="btn btn-success" onclick="filterByDate()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="mb-2">Lọc theo ca:</h6>
                                    <select class="form-select" id="shiftFilter" onchange="filterByShift()">
                                        <option value="">Tất cả ca</option>
                                        <option value="MORNING">Ca sáng</option>
                                        <option value="AFTERNOON">Ca chiều</option>
                                        <option value="EVENING">Ca tối</option>
                                        <option value="FULL_DAY">Cả ngày</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule List -->
                        <div class="row">
                            <div class="col-md-12">
                                <div th:if="${schedules.isEmpty()}" class="no-schedule">
                                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                                    <h5>Không có lịch làm việc</h5>
                                    <p class="text-muted">Không có lịch làm việc nào trong khoảng thời gian đã chọn.</p>
                                </div>

                                <div th:unless="${schedules.isEmpty()}">
                                    <!-- Group schedules by date -->
                                    <div th:each="date : ${schedules.stream().map(s -> s.workDate).distinct().sorted().toList()}">
                                        <div class="day-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-calendar-day me-2"></i>
                                                    <span th:text="${#temporals.format(date, 'EEEE, dd/MM/yyyy', new java.util.Locale('vi'))}"></span>
                                                </h6>
                                                <span class="badge bg-light text-dark"
                                                      th:text="${schedules.stream().filter(s -> s.workDate.equals(date)).count()} + ' lễ tân'"></span>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div th:each="schedule : ${schedules.stream().filter(s -> s.workDate.equals(date)).sorted((s1, s2) -> s1.startTime.compareTo(s2.startTime)).toList()}"
                                                 class="col-md-6 col-lg-4">
                                                <div class="card schedule-card">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="schedule-time" th:text="${schedule.startTime} + ' - ' + ${schedule.endTime}"></div>
                                                            <span th:class="'badge bg-' + ${schedule.status == T(com.spazone.enums.ScheduleStatus).SCHEDULED ? 'success' :
                                                                                             (schedule.status == T(com.spazone.enums.ScheduleStatus).COMPLETED ? 'primary' :
                                                                                              (schedule.status == T(com.spazone.enums.ScheduleStatus).CANCELLED ? 'danger' : 'secondary'))}"
                                                                  th:text="${schedule.statusDisplayName}"></span>
                                                        </div>

                                                        <div class="schedule-info mb-2">
                                                            <div><strong>Nhân viên:</strong> <span th:text="${schedule.userFullName}"></span></div>
                                                            <div><strong>Ca làm:</strong> <span th:text="${schedule.shiftTypeDisplayName}"></span></div>
                                                            <div><strong>Chi nhánh:</strong> <span th:text="${schedule.branchName}"></span></div>
                                                        </div>

                                                        <div th:if="${schedule.breakStart != null}" class="schedule-info mb-2">
                                                            <div><strong>Giờ nghỉ:</strong> <span th:text="${schedule.breakStart} + ' - ' + ${schedule.breakEnd}"></span></div>
                                                        </div>

                                                        <div th:if="${schedule.notes != null && !schedule.notes.isEmpty()}" class="schedule-info mb-2">
                                                            <div><strong>Ghi chú:</strong> <span th:text="${schedule.notes}"></span></div>
                                                        </div>

                                                        <!-- Reception-specific info -->
                                                        <div class="mt-3 pt-2 border-top">
                                                            <small class="text-muted">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                Phụ trách: Tiếp đón khách hàng, quản lý lịch hẹn
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function previousWeek() {
            const currentStart = new Date(document.getElementById('startDate').value);
            const previousStart = new Date(currentStart.getTime() - (7 * 24 * 60 * 60 * 1000));
            updateDateRange(previousStart);
        }

        function nextWeek() {
            const currentStart = new Date(document.getElementById('startDate').value);
            const nextStart = new Date(currentStart.getTime() + (7 * 24 * 60 * 60 * 1000));
            updateDateRange(nextStart);
        }

        function thisWeek() {
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            updateDateRange(startOfWeek);
        }

        function updateDateRange(startDate) {
            const endDate = new Date(startDate.getTime() + (6 * 24 * 60 * 60 * 1000));

            const url = new URL(window.location);
            url.searchParams.set('startDate', startDate.toISOString().split('T')[0]);
            url.searchParams.set('endDate', endDate.toISOString().split('T')[0]);
            window.location.href = url.toString();
        }

        function filterByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const url = new URL(window.location);
                url.searchParams.set('startDate', startDate);
                url.searchParams.set('endDate', endDate);
                window.location.href = url.toString();
            }
        }

        function filterByShift() {
            const shiftType = document.getElementById('shiftFilter').value;
            const scheduleCards = document.querySelectorAll('.schedule-card');

            scheduleCards.forEach(card => {
                const cardShift = card.getAttribute('data-shift');
                if (!shiftType || cardShift === shiftType) {
                    card.closest('.col-md-6').style.display = 'block';
                } else {
                    card.closest('.col-md-6').style.display = 'none';
                }
            });
        }

        // Set default date range to current week if not specified
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            if (!startDateInput.value) {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1));
                const endOfWeek = new Date(startOfWeek.getTime() + (6 * 24 * 60 * 60 * 1000));

                startDateInput.value = startOfWeek.toISOString().split('T')[0];
                endDateInput.value = endOfWeek.toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
